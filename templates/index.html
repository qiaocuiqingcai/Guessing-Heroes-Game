{% extends "base.html" %}

{% block title %}
{% if session.game_mode == 'lol' %}
è‹±é›„è”ç›ŸçŒœè‹±é›„
{% else %}
ç‹è€…è£è€€çŒœè‹±é›„
{% endif %}
{% endblock %}

{% block styles %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<style>
    /* è®¾ç½®æŒ‰é’®çš„ä½ç½® */
    .open-button {
        position: fixed;  /* å›ºå®šå®šä½ */
        top: 20px;        /* è·ç¦»é¡¶éƒ¨20px */
        right: 20px;      /* è·ç¦»å³è¾¹20px */
        padding: 10px 20px; /* æŒ‰é’®çš„å†…è¾¹è· */
        background-color: #ffa1c0; /* æŒ‰é’®èƒŒæ™¯è‰² */
        color: white;     /* æŒ‰é’®æ–‡å­—é¢œè‰² */
        border: none;     /* å»é™¤æŒ‰é’®è¾¹æ¡† */
        border-radius: 10px; /* åœ†è§’ */
        cursor: pointer;  /* é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºæ‰‹æŒ‡ */
        font-size: 11px;   /* å­—ä½“å¤§å° */
    }

    .open-button:hover {
        background-color: #45a049; /* é¼ æ ‡æ‚¬åœæ—¶æŒ‰é’®èƒŒæ™¯è‰² */
    }
    
    .game-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        max-width: 1000px;
        margin: 0 auto;
    }

    .guess-box {
        display: flex;
        flex-direction: row; /* æ¨ªå‘æ’åˆ— */
        align-items: center;
        justify-content: flex-start;
        background: white;
        padding: 10px 20px;
        margin: 10px 0;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        width: fit-content;
        gap: 15px; /* è®¾ç½®å¡ç‰‡ä¹‹é—´çš„é—´è· */
    }

    /* å°†åå­—æ”¾ç½®åœ¨å›¾ç‰‡ä¸Šæ–¹ */
    .guess-box .info {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .guess-box img {
        height: 80px;
        border-radius: 10px;
        margin-bottom: 10px; /* å›¾ç‰‡ä¸‹æ–¹é—´è· */
    }

    .guess-fields {
        display: flex;
        flex-direction: row; /* æ¨ªå‘æ’åˆ—å­—æ®µ */
        gap: 20px; /* è®¾ç½®å­—æ®µé—´çš„é—´è· */
    }

    .field {
        display: flex;
        flex-direction: column; /* çºµå‘æ’åˆ— */
        justify-content: center; /* å‚ç›´å±…ä¸­ */
        align-items: center; /* æ°´å¹³å±…ä¸­ */
        text-align: center; /* ç¡®ä¿æ–‡å­—å±…ä¸­ */
        padding: 5px 10px;
        border-radius: 6px;
    }

    .correct { background-color: #b6fcb6; }
    .wrong { background-color: #e0e0e0; }

    .up::after { content: " â†‘"; color: green; }
    .down::after { content: " â†“"; color: red; }

    #configForm, #guessForm {
        display: flex;
        gap: 10px;
        align-items: center;
        margin: 20px 0;
    }
    
    #guessForm {
        padding: 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        width: 100%;
    }

    .form-inner {
        display: flex;
        gap: 15px;
        align-items: center;
        justify-content: center;
        width: 100%;
    }

    input[type="text"], input[type="number"] {
        padding: 12px;
        font-size: 16px;
        width: 100%;
        border: 2px solid #ccc;
        border-radius: 8px;
        box-sizing: border-box;
    }

    .game-btn {
        padding: 12px 24px;
        font-size: 28px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        color: white;
    }

    .submit-btn {
        background-color: #00aeec;
    }

    .surrender-btn {
        background-color: #f44336;
    }

    .start-btn {
        padding: 12px 24px;
        font-size: 36px;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
    }

    .status {
        margin-top: 30px;
        font-size: 24px;
        font-weight: bold;
        color: #333;
        text-align: center;
    }

    .celebrate span {
        font-size: 48px;
        margin-right: 10px;
    }
    
    .mode-switch {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .mode-btn {
        font-size: 20px;
        padding: 13px 26px;
        background-color: #FF5722;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
    }
    
    /* ç”¨æˆ·ä¿¡æ¯é¢æ¿ */
    .user-panel {
        position: fixed;
        top: 80px;
        left: 20px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        padding: 15px;
        z-index: 100;
        width: 200px;
    }
    
    .user-panel h3 {
        margin-top: 0;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
        font-size: 16px;
    }
    
    .user-stats {
        margin-top: 10px;
    }
    
    .user-stats p {
        margin: 5px 0;
        font-size: 14px;
    }
    
    .user-actions {
        margin-top: 15px;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .user-actions a {
        text-align: center;
        padding: 8px;
        background-color: #f0f2f5;
        border-radius: 4px;
        text-decoration: none;
        color: #333;
        transition: background-color 0.3s;
        font-size: 14px;
    }
    
    .user-actions a:hover {
        background-color: #e0e0e0;
    }
    
    /* æ’è¡Œæ¦œæ ·å¼ */
    .leaderboard-panel {
        position: fixed;
        top: 80px;
        right: 20px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        padding: 15px;
        z-index: 100;
        width: 250px;
        max-height: 70vh;
        overflow-y: auto;
    }
    
    .leaderboard-panel h3 {
        margin-top: 0;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
        font-size: 16px;
    }
    
    .leaderboard-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }
    
    .leaderboard-table th {
        text-align: left;
        padding: 8px;
        background-color: #f5f5f5;
    }
    
    .leaderboard-table td {
        padding: 8px;
        border-bottom: 1px solid #eee;
    }
    
    .leaderboard-table tr:last-child td {
        border-bottom: none;
    }
    
    .leaderboard-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        margin-right: 8px;
        vertical-align: middle;
    }
    
    .leaderboard-link {
        display: block;
        text-align: center;
        margin-top: 10px;
        padding: 8px;
        background-color: #f0f2f5;
        border-radius: 4px;
        text-decoration: none;
        color: #333;
        transition: background-color 0.3s;
    }
    
    .leaderboard-link:hover {
        background-color: #e0e0e0;
    }
    
    .game-instructions {
        margin: 20px 0;
        padding: 15px;
        background-color: #f9f9f9;
        border-radius: 8px;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="game-container">
    <!-- æ’è¡Œæ¦œé¢æ¿ -->
    {% if leaderboard %}
    <div class="leaderboard-panel">
        <h3>æ’è¡Œæ¦œ</h3>
        <table class="leaderboard-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>ç©å®¶</th>
                    <th>æ¬¡æ•°</th>
                    <th>å‡†ç¡®ç‡</th>
                </tr>
            </thead>
            <tbody>
                {% for player in leaderboard %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>
                        <img src="{{ url_for('static', filename='avatars/' + player.username + '.jpg') }}" 
                             alt="{{ player.username }}" 
                             class="leaderboard-avatar"
                             onerror="this.src='{{ url_for('static', filename='avatars/default.jpg') }}'">
                        {{ player.username }}
                    </td>
                    <td>{{ player.total_games }}</td>
                    <td>{{ "%.1f"|format(player.win_rate * 100) }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <a href="{{ url_for('leaderboard') }}" class="leaderboard-link">æŸ¥çœ‹å®Œæ•´æ’è¡Œæ¦œ</a>
    </div>
    {% endif %}

    

    <div class="mode-switch">
        <form action="/switch_mode" method="POST">
            <button type="submit" name="mode" value="lol" class="mode-btn">LOLæ¨¡å¼</button>
            <button type="submit" name="mode" value="wangzhe" class="mode-btn">ç‹è€…æ¨¡å¼</button>
        </form>
    </div>
    
    <button class="open-button" onclick="openNewTab()">ä½œè€…ä¸»é¡µ</button>
    
    <h1 id="game-title">
        {% if session.game_mode == 'lol' %}
        è‹±é›„è”ç›ŸçŒœè‹±é›„å°æ¸¸æˆ
        {% else %}
        ç‹è€…è£è€€çŒœè‹±é›„å°æ¸¸æˆ
        {% endif %}
    </h1>
    
    <div class="game-instructions">
        <div>åˆ¶ä½œè€…ï¼š<strong>ä¸çˆ±å” å—‘çš„èŠ’æœ</strong></div>
        <div>ç³»ç»Ÿä¼šæ ¹æ®ç©å®¶çš„çŒœæµ‹è¾“å…¥ç»™å‡ºåé¦ˆï¼š</div>
        <div>å¦‚æœçŒœæµ‹ä¸ç­”æ¡ˆåŒ¹é…ï¼Œåˆ™æ˜¾ç¤ºä¸º<span style="color: green;">ç»¿è‰²</span>ã€‚å¦åˆ™æ˜¯<span style="color: grey;">ç°è‰²</span></div>
        <div>å¦‚æœæ˜¯æ•°å€¼ï¼Œåˆ™ä¼šæ˜¾ç¤ºé«˜äºï¼ˆ<span style="color: green;">â†‘</span>ï¼‰æˆ–ä½äºï¼ˆ<span style="color: red;">â†“</span>ï¼‰æç¤ºã€‚</div>
    </div>

    <form id="configForm">
        <button type="submit" class="start-btn">
            å¼€å§‹æ¸¸æˆ/é‡æ–°å¼€å§‹
        </button>
    </form>

    <form method="POST" id="guessForm">
        <div class="form-inner">
            <input id="heroInput" name="hero" list="heroList" placeholder="" autocomplete="off">
            <datalist id="heroList"></datalist>
            <button type="submit" class="game-btn submit-btn">
                ç¡®å®š
            </button>
            <button type="button" id="surrenderBtn" class="game-btn surrender-btn">
                æŠ•é™<span>ğŸ³ï¸</span>
            </button>
        </div>
    </form>
    
    <p>æœ¬è½®å°è¯•æ¬¡æ•°ï¼š{{ attempts }}</p>

    {% if has_surrendered %}
    <div class="status">
        <span>ğŸ³ï¸</span> æ­£ç¡®ç­”æ¡ˆæ˜¯ï¼š{{ answer_name }}
    </div>
    <div class="guess-box">
        <div class="info">
            <strong>{{ answer_name }}</strong>
            <img src="{{ url_for('static', filename=image_folder + '/' + answer_name + '.jpg') }}" alt="{{ answer_name }}">
        </div>
        <div>
            <div class="guess-fields">
                {% for field in answer_fields %}
                <div class="field correct">
                    <div><strong>{{ field.åç§° }}</strong></div>
                <div>{{ field.å€¼ }}</div></div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    {% if has_failed %}
    <div class="status">
        <span>è¶…æ¬¡æ•°å•¦ï¼</span> æ­£ç¡®ç­”æ¡ˆæ˜¯ï¼š{{ answer_name }}
    </div>
    <div class="guess-box">
        <div class="info">
            <strong>{{ answer_name }}</strong>
            <img src="{{ url_for('static', filename=image_folder + '/' + answer_name + '.jpg') }}" alt="{{ answer_name }}">
        </div>
        <div>
            <div class="guess-fields">
                {% for field in answer_fields %}
                <div class="field correct">
                    <div><strong>{{ field.åç§° }}</strong></div>
                <div>{{ field.å€¼ }}</div></div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    {% for guess in guesses|reverse %}
    <div class="guess-box">
        <div class="info">
            <strong>{{ guess.è‹±é›„å }}</strong>
            <img src="{{ url_for('static', filename=image_folder + '/' + guess.è‹±é›„å + '.jpg') }}" alt="{{ guess.è‹±é›„å }}">
        </div>
        <div>
            <div class="guess-fields">
                {% for item in guess.å­—æ®µ %}
                <div class="field {{ item.çŠ¶æ€ }}">
                    <div><strong>{{ item.åç§° }}</strong></div>
                <div>{{ item.å€¼ }}</div></div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endfor %}

    {% if has_won %}
    <div class="status celebrate">
        <span>ğŸ‰</span> æ­å–œä½ çŒœå¯¹äº†ï¼æ­£ç¡®ç­”æ¡ˆæ˜¯ï¼š{{ answer_name }}
    </div>
    <script>
        confetti({
            particleCount: 150,
            spread: 100,
            origin: { y: 0.6 }
        });
    </script>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // é¡µé¢åŠ è½½æ—¶è®¾ç½®placeholder
    document.addEventListener('DOMContentLoaded', function() {
        const heroInput = document.getElementById('heroInput');
        
        // æ£€æŸ¥å½“å‰URLè·¯å¾„
        if (window.location.pathname.includes('/lol')) {
            heroInput.placeholder = "è¯·è¾“å…¥çŒœæµ‹çš„è‹±é›„ï¼Œå¦‚å°ç‚®ï¼Œå®‰å¦®";
        } else {
            heroInput.placeholder = "è¯·è¾“å…¥çŒœæµ‹çš„è‹±é›„åï¼Œå¦‚å°ä¹”";
        }
    });

    const input = document.getElementById("heroInput");
    const datalist = document.getElementById("heroList");

    let debounceTimeout;
    input.addEventListener("input", () => {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(() => {
            const prefix = input.value;
            axios.get(`/autocomplete?prefix=${prefix}`).then(res => {
                datalist.innerHTML = "";
                res.data.forEach(name => {
                    const option = document.createElement("option");
                    option.value = name;
                    datalist.appendChild(option);
                });
            });
        }, 300);  // 300æ¯«ç§’çš„å»¶è¿Ÿ
    });
        
    document.getElementById("surrenderBtn").addEventListener("click", () => {
        if(confirm("ç¡®å®šè¦æŠ•é™å—ï¼Ÿå°†ç›´æ¥æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆã€‚")) {
            axios.post("/surrender").then(() => location.reload());
        }
    });

    function openNewTab() {
        // åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€æŒ‡å®šçš„ç½‘å€
        window.open('https://space.bilibili.com/52034298', '_blank');
    }

    document.getElementById("guessForm").addEventListener("submit", function (e) {
        // å…è®¸æ­£å¸¸æäº¤ï¼ˆPOST åˆ°åç«¯ï¼‰
        setTimeout(() => {
            document.getElementById("heroInput").focus();
        }, 100);  // ä½¿ç”¨ setTimeout æ˜¯ä¸ºäº†ç¡®ä¿é¡µé¢æ¸²æŸ“å®Œåé‡æ–°èšç„¦
    });

    document.getElementById("configForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        
        // æäº¤å¼€å§‹æ¸¸æˆè¡¨å•
        axios.post("/start", formData).then(() => {
            // æ¨¡æ‹Ÿç‚¹å‡»"ç¡®å®š"æŒ‰é’®
            document.getElementById("heroInput").value = "";
            document.querySelector("#guessForm button[type='submit']").click();
        });
    });
</script>
{% endblock %}