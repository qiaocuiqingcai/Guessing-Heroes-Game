{% extends "base.html" %}

{% block title %}
{% if session.game_mode == 'lol' %}
英雄联盟猜英雄
{% else %}
王者荣耀猜英雄
{% endif %}
{% endblock %}

{% block styles %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<style>
    /* 设置按钮的位置 */
    .open-button {
        position: fixed;  /* 固定定位 */
        top: 20px;        /* 距离顶部20px */
        right: 20px;      /* 距离右边20px */
        padding: 10px 20px; /* 按钮的内边距 */
        background-color: #ffa1c0; /* 按钮背景色 */
        color: white;     /* 按钮文字颜色 */
        border: none;     /* 去除按钮边框 */
        border-radius: 10px; /* 圆角 */
        cursor: pointer;  /* 鼠标悬停时显示手指 */
        font-size: 11px;   /* 字体大小 */
    }

    .open-button:hover {
        background-color: #45a049; /* 鼠标悬停时按钮背景色 */
    }
    
    .game-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        max-width: 1000px;
        margin: 0 auto;
    }

    .guess-box {
        display: flex;
        flex-direction: row; /* 横向排列 */
        align-items: center;
        justify-content: flex-start;
        background: white;
        padding: 10px 20px;
        margin: 10px 0;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        width: fit-content;
        gap: 15px; /* 设置卡片之间的间距 */
    }

    /* 将名字放置在图片上方 */
    .guess-box .info {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .guess-box img {
        height: 80px;
        border-radius: 10px;
        margin-bottom: 10px; /* 图片下方间距 */
    }

    .guess-fields {
        display: flex;
        flex-direction: row; /* 横向排列字段 */
        gap: 20px; /* 设置字段间的间距 */
    }

    .field {
        display: flex;
        flex-direction: column; /* 纵向排列 */
        justify-content: center; /* 垂直居中 */
        align-items: center; /* 水平居中 */
        text-align: center; /* 确保文字居中 */
        padding: 5px 10px;
        border-radius: 6px;
    }

    .correct { background-color: #b6fcb6; }
    .wrong { background-color: #e0e0e0; }

    .up::after { content: " ↑"; color: green; }
    .down::after { content: " ↓"; color: red; }

    #configForm, #guessForm {
        display: flex;
        gap: 10px;
        align-items: center;
        margin: 20px 0;
    }
    
    #guessForm {
        padding: 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        width: 100%;
    }

    .form-inner {
        display: flex;
        gap: 15px;
        align-items: center;
        justify-content: center;
        width: 100%;
    }

    input[type="text"], input[type="number"] {
        padding: 12px;
        font-size: 16px;
        width: 100%;
        border: 2px solid #ccc;
        border-radius: 8px;
        box-sizing: border-box;
    }

    .game-btn {
        padding: 12px 24px;
        font-size: 28px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        color: white;
    }

    .submit-btn {
        background-color: #00aeec;
    }

    .surrender-btn {
        background-color: #f44336;
    }

    .start-btn {
        padding: 12px 24px;
        font-size: 36px;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
    }

    .status {
        margin-top: 30px;
        font-size: 24px;
        font-weight: bold;
        color: #333;
        text-align: center;
    }

    .celebrate span {
        font-size: 48px;
        margin-right: 10px;
    }
    
    .mode-switch {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .mode-btn {
        font-size: 20px;
        padding: 13px 26px;
        background-color: #FF5722;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
    }
    
    /* 用户信息面板 */
    .user-panel {
        position: fixed;
        top: 80px;
        left: 20px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        padding: 15px;
        z-index: 100;
        width: 200px;
    }
    
    .user-panel h3 {
        margin-top: 0;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
        font-size: 16px;
    }
    
    .user-stats {
        margin-top: 10px;
    }
    
    .user-stats p {
        margin: 5px 0;
        font-size: 14px;
    }
    
    .user-actions {
        margin-top: 15px;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .user-actions a {
        text-align: center;
        padding: 8px;
        background-color: #f0f2f5;
        border-radius: 4px;
        text-decoration: none;
        color: #333;
        transition: background-color 0.3s;
        font-size: 14px;
    }
    
    .user-actions a:hover {
        background-color: #e0e0e0;
    }
    
    /* 排行榜样式 */
    .leaderboard-panel {
        position: fixed;
        top: 80px;
        right: 20px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        padding: 15px;
        z-index: 100;
        width: 250px;
        max-height: 70vh;
        overflow-y: auto;
    }
    
    .leaderboard-panel h3 {
        margin-top: 0;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
        font-size: 16px;
    }
    
    .leaderboard-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }
    
    .leaderboard-table th {
        text-align: left;
        padding: 8px;
        background-color: #f5f5f5;
    }
    
    .leaderboard-table td {
        padding: 8px;
        border-bottom: 1px solid #eee;
    }
    
    .leaderboard-table tr:last-child td {
        border-bottom: none;
    }
    
    .leaderboard-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        margin-right: 8px;
        vertical-align: middle;
    }
    
    .leaderboard-link {
        display: block;
        text-align: center;
        margin-top: 10px;
        padding: 8px;
        background-color: #f0f2f5;
        border-radius: 4px;
        text-decoration: none;
        color: #333;
        transition: background-color 0.3s;
    }
    
    .leaderboard-link:hover {
        background-color: #e0e0e0;
    }
    
    .game-instructions {
        margin: 20px 0;
        padding: 15px;
        background-color: #f9f9f9;
        border-radius: 8px;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="game-container">
    <!-- 排行榜面板 -->
    {% if leaderboard %}
    <div class="leaderboard-panel">
        <h3>排行榜</h3>
        <table class="leaderboard-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>玩家</th>
                    <th>次数</th>
                    <th>准确率</th>
                </tr>
            </thead>
            <tbody>
                {% for player in leaderboard %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>
                        <img src="{{ url_for('static', filename='avatars/' + player.username + '.jpg') }}" 
                             alt="{{ player.username }}" 
                             class="leaderboard-avatar"
                             onerror="this.src='{{ url_for('static', filename='avatars/default.jpg') }}'">
                        {{ player.username }}
                    </td>
                    <td>{{ player.total_games }}</td>
                    <td>{{ "%.1f"|format(player.win_rate * 100) }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <a href="{{ url_for('leaderboard') }}" class="leaderboard-link">查看完整排行榜</a>
    </div>
    {% endif %}

    

    <div class="mode-switch">
        <form action="/switch_mode" method="POST">
            <button type="submit" name="mode" value="lol" class="mode-btn">LOL模式</button>
            <button type="submit" name="mode" value="wangzhe" class="mode-btn">王者模式</button>
        </form>
    </div>
    
    <button class="open-button" onclick="openNewTab()">作者主页</button>
    
    <h1 id="game-title">
        {% if session.game_mode == 'lol' %}
        英雄联盟猜英雄小游戏
        {% else %}
        王者荣耀猜英雄小游戏
        {% endif %}
    </h1>
    
    <div class="game-instructions">
        <div>制作者：<strong>不爱唠嗑的芒果</strong></div>
        <div>系统会根据玩家的猜测输入给出反馈：</div>
        <div>如果猜测与答案匹配，则显示为<span style="color: green;">绿色</span>。否则是<span style="color: grey;">灰色</span></div>
        <div>如果是数值，则会显示高于（<span style="color: green;">↑</span>）或低于（<span style="color: red;">↓</span>）提示。</div>
    </div>

    <form id="configForm">
        <button type="submit" class="start-btn">
            开始游戏/重新开始
        </button>
    </form>

    <form method="POST" id="guessForm">
        <div class="form-inner">
            <input id="heroInput" name="hero" list="heroList" placeholder="" autocomplete="off">
            <datalist id="heroList"></datalist>
            <button type="submit" class="game-btn submit-btn">
                确定
            </button>
            <button type="button" id="surrenderBtn" class="game-btn surrender-btn">
                投降<span>🏳️</span>
            </button>
        </div>
    </form>
    
    <p>本轮尝试次数：{{ attempts }}</p>

    {% if has_surrendered %}
    <div class="status">
        <span>🏳️</span> 正确答案是：{{ answer_name }}
    </div>
    <div class="guess-box">
        <div class="info">
            <strong>{{ answer_name }}</strong>
            <img src="{{ url_for('static', filename=image_folder + '/' + answer_name + '.jpg') }}" alt="{{ answer_name }}">
        </div>
        <div>
            <div class="guess-fields">
                {% for field in answer_fields %}
                <div class="field correct">
                    <div><strong>{{ field.名称 }}</strong></div>
                <div>{{ field.值 }}</div></div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    {% if has_failed %}
    <div class="status">
        <span>超次数啦！</span> 正确答案是：{{ answer_name }}
    </div>
    <div class="guess-box">
        <div class="info">
            <strong>{{ answer_name }}</strong>
            <img src="{{ url_for('static', filename=image_folder + '/' + answer_name + '.jpg') }}" alt="{{ answer_name }}">
        </div>
        <div>
            <div class="guess-fields">
                {% for field in answer_fields %}
                <div class="field correct">
                    <div><strong>{{ field.名称 }}</strong></div>
                <div>{{ field.值 }}</div></div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    {% for guess in guesses|reverse %}
    <div class="guess-box">
        <div class="info">
            <strong>{{ guess.英雄名 }}</strong>
            <img src="{{ url_for('static', filename=image_folder + '/' + guess.英雄名 + '.jpg') }}" alt="{{ guess.英雄名 }}">
        </div>
        <div>
            <div class="guess-fields">
                {% for item in guess.字段 %}
                <div class="field {{ item.状态 }}">
                    <div><strong>{{ item.名称 }}</strong></div>
                <div>{{ item.值 }}</div></div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endfor %}

    {% if has_won %}
    <div class="status celebrate">
        <span>🎉</span> 恭喜你猜对了！正确答案是：{{ answer_name }}
    </div>
    <script>
        confetti({
            particleCount: 150,
            spread: 100,
            origin: { y: 0.6 }
        });
    </script>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // 页面加载时设置placeholder
    document.addEventListener('DOMContentLoaded', function() {
        const heroInput = document.getElementById('heroInput');
        
        // 检查当前URL路径
        if (window.location.pathname.includes('/lol')) {
            heroInput.placeholder = "请输入猜测的英雄，如小炮，安妮";
        } else {
            heroInput.placeholder = "请输入猜测的英雄名，如小乔";
        }
    });

    const input = document.getElementById("heroInput");
    const datalist = document.getElementById("heroList");

    let debounceTimeout;
    input.addEventListener("input", () => {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(() => {
            const prefix = input.value;
            axios.get(`/autocomplete?prefix=${prefix}`).then(res => {
                datalist.innerHTML = "";
                res.data.forEach(name => {
                    const option = document.createElement("option");
                    option.value = name;
                    datalist.appendChild(option);
                });
            });
        }, 300);  // 300毫秒的延迟
    });
        
    document.getElementById("surrenderBtn").addEventListener("click", () => {
        if(confirm("确定要投降吗？将直接显示正确答案。")) {
            axios.post("/surrender").then(() => location.reload());
        }
    });

    function openNewTab() {
        // 在新标签页打开指定的网址
        window.open('https://space.bilibili.com/52034298', '_blank');
    }

    document.getElementById("guessForm").addEventListener("submit", function (e) {
        // 允许正常提交（POST 到后端）
        setTimeout(() => {
            document.getElementById("heroInput").focus();
        }, 100);  // 使用 setTimeout 是为了确保页面渲染完后重新聚焦
    });

    document.getElementById("configForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        
        // 提交开始游戏表单
        axios.post("/start", formData).then(() => {
            // 模拟点击"确定"按钮
            document.getElementById("heroInput").value = "";
            document.querySelector("#guessForm button[type='submit']").click();
        });
    });
</script>
{% endblock %}